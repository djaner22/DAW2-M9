/* uglify - 2020-11-02 09:11:52 - */
PushNotification=function(e,t,n,r,i,o,s){var a={__deferredPrompt:null,registration:null,currentPushVersion:3,_init:function(e,t,r,n,i,o,s){return"PushManager"in window&&"Notification"in window&&!(!1 in navigator)&&(window.addEventListener("beforeinstallprompt",function(e){e.preventDefault(),a.deferredPrompt=e}),navigator.serviceWorker.register(e).then(function(e){a.registration=e;var t,n=0<s;if(n&&null==localStorageHandler.getObject("refuseApp")&&a._isPageValidToPush(r)){if(!n)return;a._needToPromptInstall(s)&&a._promptInstall()}window.Notification&&"granted"!==Notification.permission?(a._initEvent(),a._showPushRequestBlock()):(a._getPushVersion()<a.currentPushVersion&&a._resetSubscription(),a._hidePushRequestBlock(),a.registration.pushManager.getSubscription().then(function(e){isSubscribed=!(null===e),a._updateSubscriptionOnServer(e),isSubscribed?oUtils.log_debug("User IS subscribed. "):oUtils.log_debug("User is NOT subscribed."),a._hidePushRequestBlock()})),o&&(null===(t=localStorageHandler.getObject("pushNbNo"))&&(t=0),a._isPageValidToPush(r)&&"granted"!==Notification.permission&&t<2&&a.incrementPageNumber())})),this},_resetSubscription:function(){localStorageHandler.remove("pushRegistered"),a._requestPermission()},_promptInstall:function(){a.deferredPrompt.prompt(),a.deferredPrompt.userChoice.then(function(e){"accepted"===e.outcome||localStorageHandler.setObject("refuseApp","true"),a.deferredPrompt=null})},_isPageValidToPush:function(e){return-1<e.indexOf("catalog/category")||-1<e.indexOf("search")||-1<e.indexOf("index")},_needToPromptInstall:function(e){var t=localStorageHandler.getObject("lastVisitDate");null===t&&localStorageHandler.setObject("lastVisitDate",moment().format("l"));var n=moment(t,"l");return e<=moment().diff(n,"days")},_initEvent:function(){$(".pushNotifAuth").click(function(){a._requestPermission()})},_isTokenSentToServer:function(e){if(null==e||localStorageHandler.getObject("pushRegistered")!==e.endpoint)return!1;var t=$(".selectlang").find(".active").data("selenium"),n=localStorageHandler.getObject("pushLang");return!t||t===n},_getPushVersion:function(){return version=1,localStorageHandler.getObject("pushVersion")&&(version=localStorageHandler.getObject("pushVersion")),version},_setTokenSentToServer:function(e,t){localStorageHandler.setObject("pushRegistered",e?t:"0"),e&&(localStorageHandler.setObject("pushVersion",a.currentPushVersion),localStorageHandler.setObject("pushRegisterDate",moment().format("l")));var n=$(".selectlang").find(".active").data("selenium");void 0!==n&&(e?localStorageHandler.setObject("pushLang",n):localStorageHandler.remove("pushLang"))},_showPushRequestBlock:function(){$(".pushNotifAuth").show()},_hidePushRequestBlock:function(){$(".pushNotifAuth").hide()},_requestPermission:function(){a._subscribeUser(),a.registration.pushManager.getSubscription().then(function(e){isSubscribed=!(null===e),a._updateSubscriptionOnServer(e),isSubscribed?oUtils.log_debug("User IS subscribed."):oUtils.log_debug("User is NOT subscribed."),a._hidePushRequestBlock()})},_updateSubscriptionOnServer:function(e){null==e||a._isTokenSentToServer(e)||e&&$.ajax({url:baseUrlWithLang+"/notification/registerPush.ep",type:"POST",data:{token:JSON.stringify({endpoint:e.endpoint,subscription:e})},success:function(){a._setTokenSentToServer(!0,e.endpoint)},error:function(e){oUtils.log_error(e),a._setTokenSentToServer(!1)}})},_subscribeUser:function(){var e=a._urlB64ToUint8Array(vapidKey);a.registration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:e}).then(function(e){oUtils.log_debug("User is subscribed."),a._updateSubscriptionOnServer(e),isSubscribed=!0}).catch(function(e){oUtils.log_error("Failed to subscribe the user: ",e)})},_urlB64ToUint8Array:function(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length),i=0;i<n.length;++i)r[i]=n.charCodeAt(i);return r},_showPopup:function(){$.get("/push.html",function(e){$("#modals").html(e),$("#push-modal").modal("show"),$("body").removeClass("modal-open").css("padding-right","0"),$("#push-modal .btn-yes").click(function(){localStorageHandler.setObject("pushDate",moment().format("l")),localStorageHandler.remove("pushPageViewed"),a._requestPermission()}),$("#push-modal .btn-no").click(function(){a._incrementLocalParam("pushNbNo"),localStorageHandler.remove("pushPageViewed"),localStorageHandler.setObject("pushDate",moment().format("l"))})})},_incrementLocalParam:function(e){var t=localStorageHandler.getObject(e);return null===t&&(t=0),t++,localStorageHandler.setObject(e,t),t},incrementPageNumber:function(){var e=localStorageHandler.getObject("pushDate");if(null!==e){var t=moment(e,"l");if(moment().diff(t,"days")<i)return;localStorageHandler.remove("pushDate")}var n=a._incrementLocalParam("pushPageViewed");r<=n&&a._showPopup()},_isRegisterPushToRenew:function(){registerDate=localStorageHandler.getObject("pushRegisterDate");moment();if(null!==registerDate&&(registerDate=moment(registerDate,"l"),90<moment().diff(registerDate,"days")))return!0;return!1}};return a._init(e,t,n,r,i,o,s)};var nav=navigator.userAgent,pushIsIE=0<nav.indexOf("MSIE ")||0<nav.indexOf("Trident/")||0<nav.indexOf("Edge/"),pushIsiOS=/iPad|iPhone|iPod/.test(navigator.userAgent);"Notification"in window&&"serviceWorker"in navigator&&!pushIsIE&&!pushIsiOS&&$(document).ready(function(){var e=window.location.origin+"/service_worker.js";(new AsyncLoader).waitForEntries("typeof PushNotification !== 'undefined'").then(function(){oPushNotification=new PushNotification(e,messagingSenderId,pageName,nbPageViewedToPush,nbDayUntilRePush,pushPopupEnabled,pushInstallUntilNbDay)},function(e){oUtils.log_error(e)})});